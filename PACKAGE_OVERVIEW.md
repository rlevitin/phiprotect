# phiprotect Package Overview

## Package Structure

```
phiprotect/
├── DESCRIPTION          # Package metadata and dependencies
├── NAMESPACE           # Exported functions
├── LICENSE             # MIT License
├── README.md           # Main documentation
├── INSTALL.md          # Installation guide
├── R/                  # Source code
│   ├── phi_rules.R           # PHI detection rules and management
│   ├── phi_detection.R       # Core detection functions
│   ├── phi_anonymization.R   # Anonymization strategies
│   └── phi_utils.R           # Utility and reporting functions
├── tests/
│   ├── testthat.R            # Test runner
│   └── testthat/
│       ├── test-phi_detection.R      # Detection tests
│       └── test-phi_anonymization.R  # Anonymization tests
├── inst/
│   └── extdata/              # External data files (for future use)
└── man/                      # Documentation (generated by roxygen2)
```

## Core Components

### 1. PHI Rules System (`R/phi_rules.R`)

**Purpose**: Define and manage PHI detection rules

**Key Functions**:
- `get_default_phi_rules()` - Returns HIPAA-based detection rules
- `load_custom_phi_rules()` - Load organization-specific rules
- `validate_phi_rules()` - Validate rule structure

**Rules Structure**:
```r
list(
  "pattern" = list(
    reason = "Description of PHI",
    risk = "HIGH|MEDIUM|LOW"
  )
)
```

### 2. PHI Detection (`R/phi_detection.R`)

**Purpose**: Detect PHI in column names and data structures

**Key Functions**:
- `flag_phi(col_name, rules = NULL)` - Check single column
- `detect_phi_in_data(data, rules = NULL)` - Check all columns
- `describe_structure_with_phi(data, rules = NULL)` - Safe structure analysis
- `filter_columns_by_risk(structure_info, exclude_risk = NULL)` - Filter by risk
- `summarize_phi_detection(structure_info)` - Generate summary

**Output Structure**:
```r
tibble(
  column = "LAST_NAME",
  r_type = "character",
  phi = TRUE,
  phi_reason = "Last name",
  risk_level = "HIGH"
)
```

### 3. PHI Anonymization (`R/phi_anonymization.R`)

**Purpose**: Apply risk-appropriate anonymization strategies

**Key Functions**:
- `anonymize_data(data, structure_info)` - Main anonymization function
- `anonymize_high_risk(data, col_name, r_type, reason)` - HIGH risk strategy
- `anonymize_medium_risk(data, col_name, r_type, reason)` - MEDIUM risk strategy
- `anonymize_low_risk(data, col_name, r_type, reason)` - LOW risk strategy
- `extract_anonymized_sample(data, sample_size = 300)` - One-step sampling + anonymization

**Anonymization Strategies**:
- **HIGH**: Suppression, synthetic data, generalization
- **MEDIUM**: Partial masking, controlled perturbation
- **LOW**: Minimal noise addition

### 4. Utilities (`R/phi_utils.R`)

**Purpose**: Reporting, validation, and file I/O

**Key Functions**:
- `generate_phi_report(structure_info, table_name)` - Human-readable report
- `generate_anonymization_audit_log(log, table_name)` - Audit trail
- `save_phi_structure(structure_info, output_path)` - Export to CSV
- `save_anonymized_data(result, output_path)` - Save with audit log
- `validate_column_selection(cols, structure_info, max_risk)` - Safety check

## Risk Classification

### HIGH Risk
Direct identifiers requiring aggressive anonymization:
- Names (LAST_NAME, FIRST_NAME, PAT_NAME)
- Medical identifiers (IDA, IDB, MED_ID, SSN)
- Contact info (ADDRESS, PHONE, EMAIL)
- Sensitive dates (BIRTH, DOB)
- Free text (notes)

### MEDIUM Risk
Semi-identifying information requiring moderate protection:
- Account identifiers (ACCOUNT_ID, BILLING)
- Geographic location (CITY, STATE, POSTAL)
- Personal markers (INITIALS)
- Communication numbers (PAGER, FAX)

### LOW Risk
Institutional identifiers with minimal personal linkage:
- Staff identifiers (STAFF_ID, PROVIDER_ID)
- Facility codes (FACILITY, FAC_ID, INST_ID)
- Location codes (LOCATION_ID)

### NONE
Non-PHI columns requiring no protection:
- Anonymous identifiers (Pat_ID1)
- Clinical measurements (Age, Duration)
- Aggregate data (counts, averages)

## Testing

### Test Coverage

**Detection Tests** (`tests/testthat/test-phi_detection.R`):
- ✓ HIGH risk detection
- ✓ MEDIUM risk detection
- ✓ LOW risk detection
- ✓ Non-PHI identification
- ✓ Case insensitivity
- ✓ Custom rules
- ✓ Filter functions
- ✓ Summary functions

**Anonymization Tests** (`tests/testthat/test-phi_anonymization.R`):
- ✓ HIGH risk anonymization
- ✓ MEDIUM risk anonymization
- ✓ LOW risk anonymization
- ✓ Multiple PHI columns
- ✓ Birth date handling
- ✓ Audit log generation
- ✓ Empty data handling
- ✓ Sampling functions

### Running Tests

```r
library(testthat)
library(phiprotect)

# Run all tests
test_dir("tests/testthat")

# Run specific test file
test_file("tests/testthat/test-phi_detection.R")
```

## Usage Patterns

### Pattern 1: Basic Detection
```r
df <- data.frame(Pat_ID1 = 1:10, LAST_NAME = letters[1:10])
structure <- detect_phi_in_data(df)
generate_phi_report(structure)
```

### Pattern 2: Safe Column Selection
```r
structure <- detect_phi_in_data(df)
safe_cols <- filter_columns_by_risk(structure, exclude_risk = c("HIGH", "MEDIUM"))
df_safe <- df[, safe_cols]
```

### Pattern 3: Anonymization with Audit
```r
structure <- detect_phi_in_data(df)
result <- anonymize_data(df, structure)
save_anonymized_data(result, "output.parquet")
```

### Pattern 4: Database Workflow
```r
con <- DBI::dbConnect(...)
tbl <- dplyr::tbl(con, "patients")
structure <- describe_structure_with_phi(tbl)  # 0-row introspection
sample <- extract_anonymized_sample(tbl, sample_size = 300)
save_anonymized_data(sample, "sample.parquet")
```

## Integration with MosaiqDash

### Before (Original Code)
```r
# scripts/analysis/describe_mosaiq_tables.R
source(here("scripts", "analysis", "describe_mosaiq_tables.R"))
result <- flag_phi(col_name)
```

### After (Using phiprotect)
```r
library(phiprotect)
result <- phiprotect::flag_phi(col_name)
```

### Migration Steps
1. Install phiprotect package
2. Replace direct function calls with `phiprotect::function()`
3. Remove local copies of PHI detection code
4. Update documentation references
5. Run tests to verify behavior

## Future Enhancements

Potential additions to the package:
- [ ] YAML-based rule configuration
- [ ] Support for regex-based data anonymization (not just column names)
- [ ] Integration with sdcMicro for advanced statistical disclosure control
- [ ] Vignettes for common use cases
- [ ] Performance optimization for large datasets
- [ ] Support for additional output formats (JSON, Excel)
- [ ] Compliance reporting templates
- [ ] International PHI standards (GDPR, etc.)

## Dependencies

### Required
- dplyr (>= 1.0.0) - Data manipulation
- stringr (>= 1.4.0) - String operations
- purrr (>= 0.3.0) - Functional programming
- tibble (>= 3.0.0) - Modern data frames
- readr (>= 2.0.0) - CSV I/O

### Optional
- arrow (>= 10.0.0) - Parquet format support
- DBI (>= 1.1.0) - Database interface
- dbplyr (>= 2.0.0) - Database backend for dplyr
- testthat (>= 3.0.0) - Testing framework

## License

MIT License - See LICENSE file for details

## Support and Contact

For issues, questions, or contributions:
- File issues on GitHub
- Review documentation in README.md
- Check function help: `?function_name`
- Review test files for examples

## Version History

**0.1.0** (Initial Release)
- Core PHI detection with HIPAA rules
- Risk-based classification (HIGH/MEDIUM/LOW)
- Anonymization strategies for each risk level
- Database support via dbplyr
- Comprehensive test suite
- Full documentation
